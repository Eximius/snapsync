#! /usr/bin/env ruby
require 'optparse'
require 'snapsync'

debug = false
cleanup = nil
parser = OptionParser.new do |opt|
    opt.banner = "snapsync snapper_conf target_dir"
    opt.on '--debug', 'show full backtrace on error' do
        debug = true
    end
    opt.on '--cleanup=HOUR,WEEK,MONTH,YEAR', 'performs cleanup' do |spec|
        cleanup = spec.split(',').map { |v| Integer(v) }
        while cleanup.size < 4
            cleanup << 0
        end
    end
end
config, target_dir = parser.parse(ARGV)
if !config || !target_dir
    puts parser
    exit 1
end

if debug
    Snapsync.logger.level = 'DEBUG'
end

begin
    config =
        if Pathname.new(config).file?
            Snapsync::SnapperConfig.load(config)
        else
            Snapsync::SnapperConfig.load(Pathname.new("/etc/snapper/configs/#{config}"))
        end
    target_dir = Pathname.new(target_dir)

    if cleanup
        require "snapsync/timeline_cleanup"
        cleaner = Snapsync::TimelineCleanup.new(config, target_dir)
        [:hour,:week,:month,:year].zip(cleanup) do |period, count|
            cleaner.add(period, count)
        end
        cleaner.cleanup
    else
        Snapsync::LocalSync.new(config, target_dir).sync
    end
rescue Interrupt
    Snapsync.info "Interrupted by user"
rescue Exception => e
    if debug
        raise
    else
        Snapsync.fatal e.message
    end
end

